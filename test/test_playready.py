from pyplayready.cdm import Cdm
from pyplayready.device import Device
from pyplayready.system.pssh import PSSH

import requests

device = Device.load("../cache/device/pr/hisense_smarttv_hu50a6100uw_sl3000.prd")
cdm = Cdm.from_device(device)
session_id = cdm.open()

pssh = PSSH("yAIAAAEAAQC+AjwAVwBSAE0ASABFAEEARABFAFIAIAB4AG0AbABuAHMAPQAiAGgAdAB0AHAAOgAvAC8AcwBjAGgAZQBtAGEAcwAuAG0AaQBjAHIAbwBzAG8AZgB0AC4AYwBvAG0ALwBEAFIATQAvADIAMAAwADcALwAwADMALwBQAGwAYQB5AFIAZQBhAGQAeQBIAGUAYQBkAGUAcgAiACAAdgBlAHIAcwBpAG8AbgA9ACIANAAuADAALgAwAC4AMAAiAD4APABEAEEAVABBAD4APABQAFIATwBUAEUAQwBUAEkATgBGAE8APgA8AEsARQBZAEwARQBOAD4AMQA2ADwALwBLAEUAWQBMAEUATgA+ADwAQQBMAEcASQBEAD4AQQBFAFMAQwBUAFIAPAAvAEEATABHAEkARAA+ADwALwBQAFIATwBUAEUAQwBUAEkATgBGAE8APgA8AEsASQBEAD4AcgBhAGMAMQA0AG8AZABUAEUAVABpAFkAUABXADYAUgAvAEIASQBqAEIAZwA9AD0APAAvAEsASQBEAD4APABDAEgARQBDAEsAUwBVAE0APgBBAFgAZgBBADAANQB5AGsAbAB0AGsAPQA8AC8AQwBIAEUAQwBLAFMAVQBNAD4APABMAEEAXwBVAFIATAA+AGgAdAB0AHAAcwA6AC8ALwBiAGUAZQBzAC4AcwB0AHIAZQBhAGsAcwAuAGoAcAAvAGgAdQBsAHUALwA0ADIANgA1AGUAZABkADMANgA4AGMAMwA0AGQANwA0ADkAMQBkAGUAOABkADgAMwA3ADAANwBhAGUAZgBjADYALwBSAGkAZwBoAHQAcwBNAGEAbgBhAGcAZQByAC4AYQBzAG0AeAA8AC8ATABBAF8AVQBSAEwAPgA8AC8ARABBAFQAQQA+ADwALwBXAFIATQBIAEUAQQBEAEUAUgA+AA==")
#pssh = PSSH("AAAC6HBzc2gAAAAAmgTweZhAQoarkuZb4IhflQAAAsjIAgAAAQABAL4CPABXAFIATQBIAEUAQQBEAEUAUgAgAHgAbQBsAG4AcwA9ACIAaAB0AHQAcAA6AC8ALwBzAGMAaABlAG0AYQBzAC4AbQBpAGMAcgBvAHMAbwBmAHQALgBjAG8AbQAvAEQAUgBNAC8AMgAwADAANwAvADAAMwAvAFAAbABhAHkAUgBlAGEAZAB5AEgAZQBhAGQAZQByACIAIAB2AGUAcgBzAGkAbwBuAD0AIgA0AC4AMAAuADAALgAwACIAPgA8AEQAQQBUAEEAPgA8AFAAUgBPAFQARQBDAFQASQBOAEYATwA+ADwASwBFAFkATABFAE4APgAxADYAPAAvAEsARQBZAEwARQBOAD4APABBAEwARwBJAEQAPgBBAEUAUwBDAFQAUgA8AC8AQQBMAEcASQBEAD4APAAvAFAAUgBPAFQARQBDAFQASQBOAEYATwA+ADwASwBJAEQAPgByAGEAYwAxADQAbwBkAFQARQBUAGkAWQBQAFcANgBSAC8AQgBJAGoAQgBnAD0APQA8AC8ASwBJAEQAPgA8AEMASABFAEMASwBTAFUATQA+AEEAWABmAEEAMAA1AHkAawBsAHQAawA9ADwALwBDAEgARQBDAEsAUwBVAE0APgA8AEwAQQBfAFUAUgBMAD4AaAB0AHQAcABzADoALwAvAGIAZQBlAHMALgBzAHQAcgBlAGEAawBzAC4AagBwAC8AaAB1AGwAdQAvADQAMgA2ADUAZQBkAGQAMwA2ADgAYwAzADQAZAA3ADQAOQAxAGQAZQA4AGQAOAAzADcAMAA3AGEAZQBmAGMANgAvAFIAaQBnAGgAdABzAE0AYQBuAGEAZwBlAHIALgBhAHMAbQB4ADwALwBMAEEAXwBVAFIATAA+ADwALwBEAEEAVABBAD4APAAvAFcAUgBNAEgARQBBAEQARQBSAD4A")
request = cdm.get_license_challenge(session_id, pssh.wrm_headers[0])

response = requests.post(
    url="https://bees.streaks.jp/hulu/4265edd368c34d7491de8d83707aefc6/RightsManager.asmx?token=eyJhbGciOiJFUzI1NiIsInR5cCI6IkpXVCJ9.eyJzaWQiOiI1YjI3NjE2NDFjMWY0ZjlkYTNhODgzNWIxYTQ1OTgwMSIsIm0iOiJodWx1IiwidHMiOjE3NTM4NjYyODEsImsiOiIzNTQxYjRkOGM0ZGQ0YjAyOGRiZWYyMGJhYjBlODQ1OCIsImFpZCI6ImNvbnRlbnRfaWQiLCJwcCI6IjdjMmU3MDUwYzliYjQ2MmU4N2QwZjBlODEyMDQ4YmFkIn0.C6Ao57F-iAcxREoa2jzDVEVCD6WTJBx-zHWyZKFzQxvFLo2x-ViCSfKZNCd9xnwcGt0AyYU1RsZxSSK_FjqE1w",
    headers={
        'Content-Type': 'text/xml; charset=UTF-8',
    },
    data=request,
)

cdm.parse_license(session_id, response.text)

for key in cdm.get_keys(session_id):
    print(f"{key.key_id.hex}:{key.key.hex()}")

cdm.close(session_id)