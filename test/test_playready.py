from pyplayready.cdm import Cdm
from pyplayready.device import Device
from pyplayready.system.pssh import PSSH

import requests

device = Device.load("../cache/device/pr/hisense_smarttv_hu50a6100uw_sl3000.prd")
cdm = Cdm.from_device(device)
session_id = cdm.open()

pssh = PSSH("5AIAAAEAAQDaAjwAVwBSAE0ASABFAEEARABFAFIAIAB4AG0AbABuAHMAPQAiAGgAdAB0AHAAOgAvAC8AcwBjAGgAZQBtAGEAcwAuAG0AaQBjAHIAbwBzAG8AZgB0AC4AYwBvAG0ALwBEAFIATQAvADIAMAAwADcALwAwADMALwBQAGwAYQB5AFIAZQBhAGQAeQBIAGUAYQBkAGUAcgAiACAAdgBlAHIAcwBpAG8AbgA9ACIANAAuADAALgAwAC4AMAAiAD4APABEAEEAVABBAD4APABQAFIATwBUAEUAQwBUAEkATgBGAE8APgA8AEsARQBZAEwARQBOAD4AMQA2ADwALwBLAEUAWQBMAEUATgA+ADwAQQBMAEcASQBEAD4AQQBFAFMAQwBUAFIAPAAvAEEATABHAEkARAA+ADwALwBQAFIATwBUAEUAQwBUAEkATgBGAE8APgA8AEsASQBEAD4AKwBIADgAWABLAGYAaABOAEMARQBTADMAOABZAFcAdABlAFEAVwA4AFYAZwA9AD0APAAvAEsASQBEAD4APABMAEEAXwBVAFIATAA+AGgAdAB0AHAAcwA6AC8ALwBsAGkAYwBlAG4AcwBlAC4AdQBuAGUAeAB0AC4AagBwAC8AVQBOAGUAeAB0AFAAbABhAHkAUgBlAGEAZAB5AEwAaQB2AGUALwBJAG4AZABlAHgATAAuAGEAcwBtAHgAPAAvAEwAQQBfAFUAUgBMAD4APABEAFMAXwBJAEQAPgBWAGwAUgA3AEkAZABzAEkASgBFAHUAUgBkADAANgBMAGEAcQBzADIAagB3AD0APQA8AC8ARABTAF8ASQBEAD4APABDAEgARQBDAEsAUwBVAE0APgBoAHYAegBjAHEAegBSAHQAZgBlAGsAPQA8AC8AQwBIAEUAQwBLAFMAVQBNAD4APAAvAEQAQQBUAEEAPgA8AC8AVwBSAE0ASABFAEEARABFAFIAPgA=")
#pssh = PSSH("AAAC6HBzc2gAAAAAmgTweZhAQoarkuZb4IhflQAAAsjIAgAAAQABAL4CPABXAFIATQBIAEUAQQBEAEUAUgAgAHgAbQBsAG4AcwA9ACIAaAB0AHQAcAA6AC8ALwBzAGMAaABlAG0AYQBzAC4AbQBpAGMAcgBvAHMAbwBmAHQALgBjAG8AbQAvAEQAUgBNAC8AMgAwADAANwAvADAAMwAvAFAAbABhAHkAUgBlAGEAZAB5AEgAZQBhAGQAZQByACIAIAB2AGUAcgBzAGkAbwBuAD0AIgA0AC4AMAAuADAALgAwACIAPgA8AEQAQQBUAEEAPgA8AFAAUgBPAFQARQBDAFQASQBOAEYATwA+ADwASwBFAFkATABFAE4APgAxADYAPAAvAEsARQBZAEwARQBOAD4APABBAEwARwBJAEQAPgBBAEUAUwBDAFQAUgA8AC8AQQBMAEcASQBEAD4APAAvAFAAUgBPAFQARQBDAFQASQBOAEYATwA+ADwASwBJAEQAPgByAGEAYwAxADQAbwBkAFQARQBUAGkAWQBQAFcANgBSAC8AQgBJAGoAQgBnAD0APQA8AC8ASwBJAEQAPgA8AEMASABFAEMASwBTAFUATQA+AEEAWABmAEEAMAA1AHkAawBsAHQAawA9ADwALwBDAEgARQBDAEsAUwBVAE0APgA8AEwAQQBfAFUAUgBMAD4AaAB0AHQAcABzADoALwAvAGIAZQBlAHMALgBzAHQAcgBlAGEAawBzAC4AagBwAC8AaAB1AGwAdQAvADQAMgA2ADUAZQBkAGQAMwA2ADgAYwAzADQAZAA3ADQAOQAxAGQAZQA4AGQAOAAzADcAMAA3AGEAZQBmAGMANgAvAFIAaQBnAGgAdABzAE0AYQBuAGEAZwBlAHIALgBhAHMAbQB4ADwALwBMAEEAXwBVAFIATAA+ADwALwBEAEEAVABBAD4APAAvAFcAUgBNAEgARQBBAEQARQBSAD4A")
request = cdm.get_license_challenge(session_id, pssh.wrm_headers[0])

response = requests.post(
    url="https://wabit-lime.ca.unext.jp/rightsmanager?play_token=eyJhbGciOiJFUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6InVuZXh0LWxscC1wcm9kLTAxIn0.eyJleHAiOjE3NTcxNDEzMTQsImNvbnRlbnRUeXBlIjoibGl2ZSIsInRpdGxlSWQiOiJMSVYwMDAwMDAwNDExIiwiZXBpc29kZUlkIjoiRVAwMDAwMDAwIiwiZHJtSWQiOiJMSVYwMDAwMDAwNDExIiwic2FsZVR5cGUiOiJGUkVFIiwicGxhdGZvcm1Db2RlIjoiYm9zIiwicGZpZCI6ImJvczAwMTM3NzA0ODYiLCJjdWlkIjoiQ00wNTY2OTM0NDkiLCJhY2NvdW50VHlwZUNvZGUiOiJTVUIiLCJzdXBlclVzZXJGbGFnIjpmYWxzZSwibWVtYmVyRmxnIjoiMSIsInZhbGlkUHJvZHVjdExpbmV1cENvZGVzIjpbXSwiaWF0IjoxNzU0NTQ5MzE0fQ.g9iwgA6L6DsAyXusHsBKEFZYL6km1ubngmKiD8PQY39jXPX7YcU6Ng5GZzq4zpnbW66sKYIpVM0RAlOfTS8utg",
    headers={
        'Content-Type': 'text/xml; charset=UTF-8',
    },
    data=request,
)

cdm.parse_license(session_id, response.text)

for key in cdm.get_keys(session_id):
    print(f"{key.key_id.hex}:{key.key.hex()}")

cdm.close(session_id)